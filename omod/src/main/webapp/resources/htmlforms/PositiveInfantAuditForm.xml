<htmlform formName="Positive Infant Audit Tool"
          formDescription=""
          formUuid="177b5d5e-dd86-11ec-9d64-0242ac120002"
          formVersion="1.0"
          formAddMetadata="yes"
          formUILocation="patientDashboard.overallActions"
          formOrder="1"
          formIcon="icon-exchange"
          formShowIf="patient.person.dead==false &amp;&amp; patient.person.age &lt; 6 "
          formDisplayStyle="Standard"
          formLabel="Positive Infant Audit Tool">
    <style>

        form label, .form label {
            float: left;
            padding: 0px 10px 0 0;
        }

        form input[type="checkbox"], form input[type="radio"], .form input[type="checkbox"], .form input[type="radio"] {
            margin: 10px 15px;
        }

        table td {
            background: #FFFFFF;
            color: #404040;
        }

        form select, .form select {
            min-width: 0px;
        }

        form input, form select, form textarea, form ul.select, .form input, .form select, .form textarea, .form
        ul.select {
            background-color: #FBFBFB;
            border: 1px solid #CEC9C9;
            border-radius: 5px;
            margin-bottom: 10px;
            padding: 10px;
            min-width: 20%;
        }

        .row {
            display: inline-flex;
            clear: both;
        }

        .results_style {
            font-weight: bold;
            color: #0808fd;
        }

        .row .row-col2 {
            float: left;
            width: 50%;
        }

        table th, table td {
            border: 1px solid #AFAFAF;
        }

        #br {
            white-space: pre;
        }

        input[type="checkbox"] {
            margin: 0px 2px;
        }

        .obs-field {

        }

        .div-col2 {
            display: table-cell;
            margin-right: auto;
            margin-left: auto;
            width: 20%;
        }
    </style>
    <script type="text/javascript">
        if (jQuery) {
            jq(document).ready(function () {
                var patientuuid = '<lookup expression="patient.uuid"/>';
                var transferInName = getEncounterTypeName("3e8354f7-31b3-4862-a52e-ff41a1ee60af");
                var transferOutName = getEncounterTypeName("e305d98a-d6a2-45ba-ba2a-682b497ce27c");
                var transferDate = getValue('encounterDate.value');

                jq('#encounter_type').change(function(){
                    transferDate= getValue('encounterDate.value');
                    var type = jq('#encounter_type option:selected').text();
                    if(type==transferInName){
                        setValue('transfer-in-date.value',transferDate);
                        setValue('transfer-out-date.value','');
                    }else if(type==transferOutName){
                       setValue('transfer-out-date.value',transferDate);
                        setValue('transfer-in-date.value','');
                    }
                });

                jq('#encounterDate').change(function(){
                    transferDate= getValue('encounterDate.value');
                    var type = jq('#encounter_type option:selected').text();
                    if(type==transferInName){
                        setValue('transfer-in-date.value',transferDate);
                        setValue('transfer-out-date.value','');
                    }else if(type==transferOutName){
                        setValue('transfer-out-date.value',transferDate);
                        setValue('transfer-in-date.value','');
                    }
                });

                // Enable disable other outcomes
                jq('#encounter_type').change(function () {
                    enable_disable_show_hide('encounter_type', '99109', 'Transfer In');
                });

                jq('#encounter_type').each(function () {
                    enable_disable_show_hide('encounter_type', '99109', 'Transfer In');
                });

                jq('#encounter_type').change(function () {
                    enable_disable_show_hide('encounter_type', 'transfer_in', 'Transfer In');
                });

                jq('#encounter_type').each(function () {
                    enable_disable_show_hide('encounter_type', 'transfer_in', 'Transfer In');
                });

                jq('#encounter_type').change(function () {
                    enable_disable_show_hide('encounter_type', 'transfer_out', 'Transfer Out');
                });

                jq('#encounter_type').each(function () {
                    enable_disable_show_hide('encounter_type', 'transfer_out', 'Transfer Out');
                });

                // Enable disable other outcomes
                jq('#encounter_type').change(function () {
                    enable_disable_show_hide('encounter_type', '90211', 'Transfer Out');
                });

                jq('#encounter_type').each(function () {
                    enable_disable_show_hide('encounter_type', '90211', 'Transfer Out');
                });


                jq('#164993').change(function () {
                    enable_disable_show_hide('164993', 'comprehensive_transfer', 'ART Clinic');
                });

                jq('#164993').each(function () {
                    enable_disable_show_hide('164993', 'comprehensive_transfer', 'ART Clinic');
                });

                jq('#90216').change(function () {
                    enable_disable('90216', '90217', 'Tb Rx');
                });

                jq('#90216').each(function () {
                    enable_disable('90216', '90217', 'Tb Rx');
                });

                jq('#90041').change(function () {
                    enable_disable('90041', '5596', 'Yes');
                });

                jq('#90041').each(function () {
                    enable_disable('90041', '5596', 'Yes');
                });

                jq('#99061').change(function () {
                    enable_disable('99061', '99268', 'OTHER');
                });

                jq('#99061').each(function () {
                    enable_disable('99061', '99268', 'OTHER');
                });


                // trigger a change when the form loads
                jq("#viral-load-results-qualitative").change(function () {
                    viral_load_widget('viral-load-results-qualitative', 'viral-load-results-copies');
                });

                jq("#viral-load-results-qualitative").each(function () {
                    viral_load_widget('viral-load-results-qualitative', 'viral-load-results-copies');
                });

                // trigger a change when the form loads
                jq("#viral-load-results-qualitative_1").change(function () {
                    viral_load_widget('viral-load-results-qualitative_1', 'viral-load-results-copies_1');
                });

                jq("#viral-load-results-qualitative_1").each(function () {
                    viral_load_widget('viral-load-results-qualitative_1', 'viral-load-results-copies_1');
                });
            });


            function viral_load_widget(triger, enabledDisabledId) {
                /* Handle viral load results */
                jq("#" + enabledDisabledId).attr("disabled", true);
                jq("#" + triger).change(function () {
                    var viral_load_status = getValue(triger + ".value");
                    if (viral_load_status == 1301) {
                        /* Detected */
                        enableContainer("#" + enabledDisabledId);
                        setValue(enabledDisabledId + ".value", '');
                    }
                    if (viral_load_status == 1306) {
                        /* Not Detected */
                        disableContainer("#" + enabledDisabledId);
                        setValue(enabledDisabledId + ".value", 1);
                    }
                    if (viral_load_status == "" || viral_load_status == 1304) {
                        /* Sample Rejected and no data */
                        disableContainer("#" + enabledDisabledId);
                        setValue(enabledDisabledId + ".value", '');
                    }
                });
            }

            function enable_disable_show_hide(triggerId, enabledDisabledId, conditionValue) {
                if (jq("#" + triggerId + " :selected").text() === conditionValue) {
                    showContainer('#' + enabledDisabledId);
                } else if (jq('#' + triggerId).find('span').text() === conditionValue) {
                    showContainer('#' + enabledDisabledId);
                } else {
                    hideContainer('#' + enabledDisabledId);

                }
            }

            function enable_disable(triggerId, enabledDisabledId, conditionValue) {
                disableContainer('#'+enabledDisabledId);
                if (jq("#" + triggerId + " :selected").text() === conditionValue) {
                    enableContainer('#' + enabledDisabledId);
                } else if (jq('#' + triggerId).find('span').text() === conditionValue) {
                    enableContainer('#' + enabledDisabledId);
                } else {
                    disableContainer('#' + enabledDisabledId);
                }
            }

            function validateRequiredFieldsByValue(triggerId, validateFieldId, triggerValue, message_to_throw, validateFieldType) {
                var selected_value = jq("#" + triggerId).find(":selected").text().trim().toLowerCase();
                var validateFieldValue = "";

                if (validateFieldType === "input_text") {
                    validateFieldValue = jq("#" + validateFieldId).find("input:text").val();
                } else if (validateFieldType === "textarea") {
                    validateFieldValue = jq("#" + validateFieldId).find("textarea").value;
                }

                if (selected_value === triggerValue &amp;&amp; validateFieldValue === "") {
                    getField(validateFieldId + '.error').html(message_to_throw).show;
                    jq('#' + validateFieldId).find("span").removeAttr("style");

                    return false;
                }
                else {
                    return true;
                }
            }



        }
    </script>
    <div class="ai-page-frame">
        <div class="headers" style="text-align: center;">
            <h3 style="background: #94979A; padding: 10px;">Positive Infant Audit Form</h3>
        </div>

            <div class="ai-page-frame" id="transfer_out">
                <div class="headers" style="text-align: center;">
                    <h3>Comprehensive HIV Care/ART Patient Referral/Transfer</h3>
                </div>
                <section>
                    <table class="enrollment">
                        <tbody>
                        <tr>
                            <th>Patient ART History</th>
                            <th>Baseline Lab (At Start of ART)</th>
                            <th>Baseline Clinic Status</th>
                        </tr>
                        <tr>
                            <td>
                                <div style="width: 100%">
                                    <label>Infant Age:</label>
                                    <lookup class="results_style" expression="fn.latestObs('99061').valueCoded.name"/>
                                </div>
                                <div style="width: 100%">
                                    <label>EXP Number</label>
                                    <lookup class="results_style" expression="fn.latestObs('99268').valueText"/>
                                </div>
                                <br/>

                                <div style="width: 100%">
                                    <label>Date of Sample Collection:</label>
                                    <lookup class="results_style" expression="fn.latestObs('99606').valueDatetime"/>
                                </div>

                                <div style="width: 100%">
                                    <label>Date of Sample Recieved at Lab:</label>
                                    <lookup class="results_style" expression="fn.latestObs('99606').valueDatetime"/>
                                </div>

                                <div style="width: 100%">
                                    <label>UNHLS Number</label>
                                    <lookup class="results_style" expression="fn.latestObs('99606').valueDatetime"/>
                                </div>
                            </td>
                            <td>

                                <div style="width: 100%" class="lookup">
                                    <label>Viral Load:</label>
                                    <lookup class="results_style" expression="fn.latestObs('163029').valueNumeric"/>
                                </div>
                                <br/>
                                <div style="width: 100%" class="lookup">
                                    <label>HB:</label>
                                    <lookup class="results_style" expression="fn.latestObs('163028').valueNumeric"/>
                                </div>
                                <br/>
                                <div style="width: 100%" class="lookup">
                                    <label>CD4:</label>
                                    <lookup class="results_style" expression="fn.latestObs('99071').valueNumeric"/>
                                </div>
                                <br/>
                                <div style="width: 100%" class="lookup">
                                    <label>CD4 (%):</label>
                                    <lookup class="results_style" expression="fn.latestObs('99145').valueNumeric"/>
                                </div>
                                <br/>
                                <div style="width: 100%" class="lookup">
                                    <label>TLC:</label>
                                    <lookup class="results_style" expression="fn.latestObs('163024').valueNumeric"/>
                                </div>
                            </td>
                            <td>
                                <div style="width: 100%">
                                    <label>Weight:</label>
                                    <lookup class="results_style" expression="fn.latestObs('99069').valueNumeric"/>
                                </div>
                                <br/>
                                <div style="width: 100%">
                                    <label>Height:</label>
                                    <lookup class="results_style" expression="fn.latestObs('163025').valueNumeric"/>
                                </div>
                                <br/>
                                <div style="width: 100%">
                                    <label>WHO Clinic Status:</label>
                                    <lookup class="results_style" expression="fn.latestObs('99070').valueCoded.name"/>
                                </div>
                                <br/>
                                <div style="width: 100%">
                                    <label>Functional Status:</label>
                                    <lookup class="results_style" expression="fn.latestObs('163027').valueCoded.name"/>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </section>

                <section>
                    <table class="enrollment">
                        <tbody>
                        <tr>
                            <th>Current Regimen</th>
                            <th>Most Recent Lab(Date done)</th>
                            <th>Current Clinic Status</th>
                        </tr>
                        <tr>
                            <td>
                                <div style="width: 100%">
                                    <label>Regimen:</label>
                                    <lookup class="results_style" expression="fn.latestObs('90315').valueCoded.name"/>
                                    <lookup class="results_style" expression="fn.latestObs('99126').valueText"/>
                                </div>
                                <div style="width: 100%">
                                    <label>Regimen Issued until:</label>
                                    <lookup class="results_style" expression="fn.latestObs('90315').dateCreated"/>
                                    <lookup class="results_style" expression="fn.latestObs('99126').dateCreated"/>
                                </div>
                            </td>
                            <td>
                                <div style="width: 100%" class="lookup">
                                    <label>Viral Load:</label>
                                    <lookup class="results_style" expression="fn.latestObs('1305').valueCoded.name"/>
                                    <lookup class="results_style" expression="fn.latestObs('856').valueNumeric"/>
                                </div>
                                <br/>
                                <div style="width: 100%" class="lookup">
                                    <label>HB:</label>
                                    <lookup class="results_style" expression="fn.latestObs('21').valueNumeric"/>
                                </div>
                                <br/>
                                <div style="width: 100%" class="lookup">
                                    <label>CD4:</label>
                                    <lookup class="results_style" expression="fn.latestObs('5497').valueNumeric"/>
                                </div>
                                <br/>
                                <div style="width: 100%" class="lookup">
                                    <label>CD4 (%):</label>
                                    <lookup class="results_style" expression="fn.latestObs('730').valueNumeric"/>
                                </div>
                                <br/>
                                <div style="width: 100%" class="lookup">
                                    <label>TLC:</label>
                                    <lookup class="results_style" expression="fn.latestObs('1021').valueNumeric"/>
                                </div>
                            </td>
                            <td>

                                <div style="width: 100%">
                                    <label>Weight:</label>
                                    <lookup class="results_style" expression="fn.latestObs('90236').valueNumeric"/>
                                </div>
                                <br/>
                                <div style="width: 100%">
                                    <label>Height:</label>
                                    <lookup class="results_style" expression="fn.latestObs('5090').valueNumeric"/>
                                </div>
                                <br/>
                                <div style="width: 100%">
                                    <label>WHO Clinic Status:</label>
                                    <lookup class="results_style" expression="fn.latestObs('90203').valueCoded.name"/>
                                </div>
                                <br/>
                                <div style="width: 100%">
                                    <label>Functional Status:</label>
                                    <lookup class="results_style" expression="fn.latestObs('90235').valueCoded.name"/>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </section>

                <section>
                    <table class="enrollment">
                        <tbody>
                        <tr>
                            <th>TB Status</th>
                            <th>Other Opportunist Infections<br/> and Medications</th>
                            <th>Pregnancy Status</th>
                        </tr>
                        <tr>

                            <td>
                                <div style="width: 100%">
                                    <label>TB Status:</label>
                                    <lookup class="results_style" expression="fn.latestObs('90216').valueCoded.name"/>
                                </div>
                                <br/>
                                <div style="width: 100%">
                                    <label>TB Start Date:</label>
                                    <lookup class="results_style" expression="fn.latestObs('90217').valueDatetime"/>
                                </div>
                                <br/>
                            </td>

                            <td>
                                <div style="width: 100%">
                                    <label>Other Opportunist Infections:</label>
                                    <lookup class="results_style" expression="fn.latestObs('90251').valueCoded.name"/>
                                    <lookup class="results_style" expression="fn.latestObs('99032').valueText"/>
                                </div>
                                <br/>
                                <div style="width: 100%">
                                    <label>Other Medications:</label>
                                    <lookup class="results_style" expression="fn.latestObs('1193').valueCoded.name"/>
                                    <lookup class="results_style" expression="fn.latestObs('99035').valueText"/>
                                </div>
                            </td>
                            <td>
                                <excludeIf velocityTest="$patient.gender =='M' || $patient.age &lt; 9">
                                    <div style="width: 100%">
                                        <label>Pregnant:</label>
                                        <lookup class="results_style"
                                                expression="fn.latestObs('90041').valueCoded.name"/>
                                    </div>

                                    <div style="width: 100%">
                                        <label>EDD:</label>
                                        <lookup class="results_style" expression="fn.latestObs('5596').valueDatetime"/>
                                        <br/>
                                    </div>
                                </excludeIf>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="3">
                                <label>Any Drug Allergies</label>
                                <div style="width: 100%">
                                    <label>Other Medications:</label>
                                    <lookup class="results_style"
                                            complexExpression="#foreach($allergy in $fn.allObs(142)) $allergy.valueText #end"/>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="3">
                                <label>Reasons For Transfer</label>
                                <obs id="99387_2" class="text-box-styling" conceptId="99387" size="30" style="textarea"
                                     rows="5"
                                     cols="80"/>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </section>
            </div>
        </div>
        <br/>
    <postSubmissionAction class="org.openmrs.module.ugandaemr.htmlformentry.PatientReferralPostSubmissionAction"/>
</htmlform>